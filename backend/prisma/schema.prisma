
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  CUSTOMER
  VENDOR
  COURIER
  ADMIN
}

enum VendorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum OrderStatus {
  PLACED
  ACCEPTED
  PREPARING
  READY_FOR_PICKUP
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
}

enum DeliveryMode {
  PICKUP
  DELIVERY
}

enum PaymentMethod {
  CARD
  TRANSFER
  PARTIAL_COURIER
}

model User {
  id         String   @id @default(uuid())
  email      String   @unique
  phone      String   @unique
  password   String
  fullName   String
  role       UserRole @default(CUSTOMER)
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  orders         Order[]         @relation("CustomerOrders")
  vendorProfile  VendorProfile?
  courierProfile CourierProfile?
  reviews        Review[]
  wallet         Wallet?
  hostedGroupCarts GroupCart[]
  
  // Settings
  dataSaverEnabled Boolean @default(false)
}

model GroupCart {
  id        String   @id @default(uuid())
  code      String   @unique // Short code for sharing
  host      User     @relation(fields: [hostId], references: [id])
  hostId    String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  
  items     GroupCartItem[]
}

model GroupCartItem {
  id          String    @id @default(uuid())
  cart        GroupCart @relation(fields: [cartId], references: [id])
  cartId      String
  menuItem    MenuItem  @relation(fields: [menuItemId], references: [id])
  menuItemId  String
  quantity    Int
  addedBy     String    // Name of guest or User ID
  addedById   String?   // Optional link if guest is a reg user
}

model Wallet {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @unique
  balance   Float    @default(0.00)
  currency  String   @default("NGN")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String   @id @default(uuid())
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  walletId    String
  amount      Float
  type        TransactionType
  reference   String   @unique // Integration ref (e.g. Paystack Ref or Order ID)
  description String?
  status      TransactionStatus @default(PENDING)
  createdAt   DateTime @default(now())
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  PAYMENT
  REFUND
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model VendorProfile {
  id        String       @id @default(uuid())
  user      User         @relation(fields: [userId], references: [id])
  userId    String       @unique
  name      String       // Business Name
  location  String
  address   String
  bvn       String?
  rcNumber  String?
  status    VendorStatus @default(PENDING)
  isOpen    Boolean      @default(true)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  menuItems MenuItem[]
  orders    Order[]
  categories Category[]
}

model Category {
  id        String        @id @default(uuid())
  vendor    VendorProfile @relation(fields: [vendorId], references: [id])
  vendorId  String
  name      String
  menuItems MenuItem[]
}

model MenuItem {
  id                  String   @id @default(uuid())
  vendor              VendorProfile @relation(fields: [vendorId], references: [id])
  vendorId            String
  category            Category @relation(fields: [categoryId], references: [id])
  categoryId          String
  name                String
  description         String?
  price               Float
  imageUrl            String?
  videoUrl            String?
  isAvailable         Boolean  @default(true)
  customizationConfig String?  // JSON string
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  orderItems          OrderItem[]
  groupCartItems      GroupCartItem[]
}

model Order {
  id          String      @id @default(uuid())
  customer    User        @relation("CustomerOrders", fields: [customerId], references: [id])
  customerId  String
  vendor      VendorProfile @relation(fields: [vendorId], references: [id])
  vendorId    String
  courier     CourierProfile? @relation(fields: [courierId], references: [id])
  courierId   String?
  
  status        OrderStatus   @default(PLACED)
  deliveryMode  DeliveryMode  @default(DELIVERY)
  paymentMethod PaymentMethod @default(CARD)
  
  // Financial Fields
  foodSubtotal       Float
  deliveryFee        Float
  taxAmount          Float  // 7.5% VAT
  totalAmount        Float
  amountPaidUpfront  Float
  amountDueOnDelivery Float @default(0)

  deliveryAddress String
  proofOfDeliveryUrl String?
  deliveryLat     Float?
  deliveryLng     Float?

  items       OrderItem[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  
  review      Review?
}

model OrderItem {
  id         String   @id @default(uuid())
  order      Order    @relation(fields: [orderId], references: [id])
  orderId    String
  menuItem   MenuItem @relation(fields: [menuItemId], references: [id])
  menuItemId String
  quantity   Int
  price      Float    // Price at the time of order
}

model CourierProfile {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String   @unique
  vehicleType String
  isOnline    Boolean  @default(false)
  currentLat  Float?
  currentLng  Float?
  cashBalance Float    @default(0) // Debt to platform
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders Order[]
}

model Review {
  id        String   @id @default(uuid())
  order     Order    @relation(fields: [orderId], references: [id])
  orderId   String   @unique // One review per order
  customer  User     @relation(fields: [customerId], references: [id])
  customerId String
  rating    Int
  text      String?
  videoUrl  String?
  createdAt DateTime @default(now())
}
